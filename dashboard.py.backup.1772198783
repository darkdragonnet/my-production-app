import streamlit as st
import requests
import os
import pandas as pd
from datetime import datetime

st.set_page_config(page_title="Zalo Bot Dashboard", layout="wide")

# L·∫•y c·∫•u h√¨nh t·ª´ Environment Variables c·ªßa Docker
FLASK_API_URL = os.getenv("FLASK_API_URL", "http://zalo-flask-api:5001")

st.title("üì± Zalo Bot Production Dashboard")

FLASK_API_URL = os.getenv("FLASK_API_URL", "http://zalo-flask-api:5001")

st.title("üìä Zalo Bot Admin Dashboard")

# --- TH√äM KH·ªêI HI·ªÇN TH·ªä TH√îNG TIN BOT ---
st.header("ü§ñ Th√¥ng tin Zalo Bot")
try:
    with st.spinner("ƒêang t·∫£i th√¥ng tin t·ª´ Zalo..."):
        res = requests.get(f"{FLASK_API_URL}/bot-info", timeout=5)
        
        if res.status_code == 200:
            data = res.json()
            if data.get("ok"):
                bot_info = data["result"]
                
                # Hi·ªÉn th·ªã 3 c·ªôt th√¥ng tin ƒë·∫πp m·∫Øt
                col1, col2, col3 = st.columns(3)
                col1.metric("T√™n Bot", bot_info.get("account_name", "N/A"))
                col2.metric("Bot ID", bot_info.get("id", "N/A"))
                col3.metric("Lo·∫°i t√†i kho·∫£n", bot_info.get("account_type", "N/A"))
                
                if bot_info.get("can_join_groups"):
                    st.success("‚úÖ Bot n√†y C√ì quy·ªÅn tham gia nh√≥m.")
                else:
                    st.info("‚ÑπÔ∏è Bot n√†y KH√îNG C√ì quy·ªÅn tham gia nh√≥m.")
            else:
                st.warning("‚ö†Ô∏è Zalo API kh√¥ng tr·∫£ v·ªÅ d·ªØ li·ªáu h·ª£p l·ªá.")
        else:
            st.error(f"‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh ZALO_BOT_TOKEN ho·∫∑c token kh√¥ng h·ª£p l·ªá.")
except Exception as e:
    st.error(f"‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn Flask API: {e}")

#st.divider()

# Ki·ªÉm tra tr·∫°ng th√°i API
st.divider()

# --- T·∫†O TABS GIAO DI·ªÜN ---
tab1, tab2 = st.tabs([
    "üì® L·ªãch s·ª≠ Tin nh·∫Øn & Webhook",
    "üë• Qu·∫£n l√Ω Ng∆∞·ªùi d√πng (Followers)"
])

# ==========================================
# TAB 1: L·ªäCH S·ª¨ WEBHOOK
# ==========================================
with tab1:
    col_btn, col_space = st.columns([1, 4])
    if col_btn.button("üîÑ L√†m m·ªõi tin nh·∫Øn", key="btn_msg",
                      use_container_width=True):
        st.rerun()

    try:
        with st.spinner("ƒêang t·∫£i d·ªØ li·ªáu tin nh·∫Øn..."):
            res = requests.get(f"{FLASK_API_URL}/get-messages", timeout=5)
            if res.status_code == 200:
                messages = res.json().get("messages", [])
                if messages:
                    df = pd.DataFrame(messages)
                    display_df = df[[
                        'timestamp', 'event_name', 'sender_id',
                        'message_text'
                    ]]
                    display_df.columns = [
                        'Th·ªùi gian', 'S·ª± ki·ªán',
                        'Zalo ID Ng∆∞·ªùi g·ª≠i', 'N·ªôi dung tin nh·∫Øn'
                    ]
                    st.dataframe(
                        display_df,
                        use_container_width=True,
                        hide_index=True
                    )

                    with st.expander("üîç Xem d·ªØ li·ªáu JSON th√¥"):
                        st.json(messages)
                else:
                    st.info("üì≠ Ch∆∞a c√≥ tin nh·∫Øn n√†o.")
    except Exception as e:
        st.error(f"‚ùå L·ªói t·∫£i tin nh·∫Øn: {e}")

# ==========================================
# TAB 2: QU·∫¢N L√ù NG∆Ø·ªúI D√ôNG (FOLLOWERS)
# ==========================================
with tab2:
    col_btn2, col_space2 = st.columns([1, 4])
    if col_btn2.button("üîÑ L√†m m·ªõi danh s√°ch", key="btn_user",
                       use_container_width=True):
        st.rerun()

    try:
        with st.spinner("ƒêang t·ªïng h·ª£p d·ªØ li·ªáu ng∆∞·ªùi d√πng..."):
            res_users = requests.get(
                f"{FLASK_API_URL}/followers",
                timeout=5
            )

            if res_users.status_code == 200:
                data = res_users.json()
                followers = data.get("followers", [])
                total = data.get("total_followers", 0)

                st.metric(
                    label="üåü T·ªïng s·ªë ng∆∞·ªùi d√πng ƒë√£ t∆∞∆°ng t√°c",
                    value=f"{total} ng∆∞·ªùi"
                )

                if followers:
                    df_users = pd.DataFrame(followers)
                    df_users.columns = [
                        'Zalo ID (UID)',
                        'L·∫ßn ho·∫°t ƒë·ªông cu·ªëi',
                        'T·ªïng s·ªë l·∫ßn t∆∞∆°ng t√°c'
                    ]

                    st.dataframe(
                        df_users,
                        use_container_width=True,
                        hide_index=True
                    )
                else:
                    st.info(
                        "Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o t∆∞∆°ng t√°c v·ªõi Bot."
                    )
    except Exception as e:
        st.error(f"‚ùå L·ªói t·∫£i danh s√°ch ng∆∞·ªùi d√πng: {e}")


st.write("---")
st.subheader("D·ªØ li·ªáu tin nh·∫Øn m·ªõi nh·∫•t")
# Gi·∫£ l·∫≠p ho·∫∑c fetch data t·ª´ database ·ªü ƒë√¢y
df = pd.DataFrame({
    'Th·ªùi gian': [datetime.now().strftime("%H:%M:%S")],
    'Ng∆∞·ªùi g·ª≠i': ['H·ªá th·ªëng'],
    'N·ªôi dung': ['ƒê√£ c·∫≠p nh·∫≠t code th√†nh c√¥ng qua EOF']
})
st.table(df)
